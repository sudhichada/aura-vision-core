rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 1. Users Table
    // user_id (PK) -> document ID
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId); // Users can update their own profile/preferences
      
      // Schema validation could be enforced here or in backend
      // preferences_profile: map
    }

    // 2. Products Table (Existing E-commerce Catalog)
    // product_id (PK) -> document ID
    match /products/{productId} {
      allow read: if true; // Publicly readable
      allow write: if false; // Only admin/backend can write
      
      // Fields: sku, dimensions, style_tags, texture_map_url
    }

    // 3. Visualizations Table (The Core "Aura Vision" Artifacts)
    // visualization_id (PK) -> document ID
    match /visualizations/{visualizationId} {
      allow read: if isAuthenticated() && (resource.data.user_id == request.auth.uid);
      allow create: if isAuthenticated() && (request.resource.data.user_id == request.auth.uid);
      allow update: if isAuthenticated() && (resource.data.user_id == request.auth.uid);
      
      // Fields: base_image_url, generated_image_url, depth_map_data, prompt_context, feedback_rating
    }

    // 4. Explanation_Log Table (For the "Why This Match?" Feature)
    // log_id (PK) -> document ID
    match /explanation_logs/{logId} {
      allow read: if isAuthenticated() && 
        get(/databases/$(database)/documents/visualizations/$(resource.data.visualization_id)).data.user_id == request.auth.uid;
      allow write: if false; // Generated by system/backend only
      
      // Fields: visualization_id, detected_features, reasoning_text
    }
  }
}
